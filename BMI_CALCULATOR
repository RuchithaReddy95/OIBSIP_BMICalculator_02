import tkinter as tk
from tkinter import ttk, messagebox
import sqlite3
import matplotlib.pyplot as plt
from datetime import datetime

DB_FILE = "bmi_data.db"

# ---------------- DATABASE ---------------- #
def init_db():
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()

    cur.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE
        )
    """)

    cur.execute("""
        CREATE TABLE IF NOT EXISTS bmi_records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            weight REAL,
            height REAL,
            bmi REAL,
            category TEXT,
            date TEXT,
            FOREIGN KEY(user_id) REFERENCES users(id)
        )
    """)

    conn.commit()
    conn.close()


def get_users():
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()
    cur.execute("SELECT name FROM users")
    users = [u[0] for u in cur.fetchall()]
    conn.close()
    return users


def add_user(name):
    try:
        conn = sqlite3.connect(DB_FILE)
        cur = conn.cursor()
        cur.execute("INSERT INTO users (name) VALUES (?)", (name,))
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    finally:
        conn.close()


def save_bmi(user, weight, height, bmi, category):
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()

    cur.execute("SELECT id FROM users WHERE name=?", (user,))
    user_id = cur.fetchone()[0]

    date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    cur.execute("""
        INSERT INTO bmi_records
        (user_id, weight, height, bmi, category, date)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (user_id, weight, height, bmi, category, date))

    conn.commit()
    conn.close()


def get_history(user):
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()

    cur.execute("""
        SELECT weight, height, bmi, category, date
        FROM bmi_records
        WHERE user_id = (SELECT id FROM users WHERE name=?)
        ORDER BY date ASC
    """, (user,))

    data = cur.fetchall()
    conn.close()
    return data


def calculate_bmi(weight, height_cm):
    height_m = height_cm / 100
    bmi = weight / (height_m ** 2)

    if bmi < 18.5:
        category = "Underweight"
    elif bmi < 25:
        category = "Normal"
    elif bmi < 30:
        category = "Overweight"
    else:
        category = "Obese"

    return round(bmi, 2), category


# ---------------- GUI ---------------- #
class BMICalculator:
    def __init__(self, root):
        self.root = root
        self.root.title("BMI Calculator")
        self.root.geometry("600x700")

        init_db()

        ttk.Label(root, text="Select or Add User").pack(pady=5)

        self.user_var = tk.StringVar()
        self.user_combo = ttk.Combobox(root, textvariable=self.user_var, values=get_users())
        self.user_combo.pack(pady=5)
        self.user_combo.bind("<<ComboboxSelected>>", self.load_history)

        self.new_user = ttk.Entry(root)
        self.new_user.pack(pady=5)

        ttk.Button(root, text="Add User", command=self.add_new_user).pack(pady=5)

        ttk.Label(root, text="Weight (kg)").pack(pady=5)
        self.weight_entry = ttk.Entry(root)
        self.weight_entry.pack(pady=5)

        ttk.Label(root, text="Height (cm)").pack(pady=5)
        self.height_entry = ttk.Entry(root)
        self.height_entry.pack(pady=5)

        ttk.Button(root, text="Calculate BMI", command=self.calculate).pack(pady=10)

        self.result_label = ttk.Label(root, text="", font=("Arial", 14))
        self.result_label.pack(pady=10)

        self.visual_label = ttk.Label(root, text="", font=("Arial", 12))
        self.visual_label.pack(pady=5)

        ttk.Button(root, text="View History", command=self.load_history).pack(pady=5)
        ttk.Button(root, text="View Trends", command=self.view_trends).pack(pady=5)

        self.history_box = tk.Listbox(root, height=12)
        self.history_box.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

    # ---------- FUNCTIONS ---------- #
    def add_new_user(self):
        name = self.new_user.get().strip()
        if name and add_user(name):
            self.user_combo["values"] = get_users()
            self.user_var.set(name)
            messagebox.showinfo("Success", "User added")
        else:
            messagebox.showerror("Error", "User already exists or invalid")

    def calculate(self):
        try:
            user = self.user_var.get()
            if not user:
                messagebox.showerror("Error", "Select a user")
                return

            weight = float(self.weight_entry.get())
            height = float(self.height_entry.get())

            bmi, category = calculate_bmi(weight, height)

            self.result_label.config(text=f"BMI: {bmi} ({category})")

            colors = {
                "Underweight": "blue",
                "Normal": "green",
                "Overweight": "orange",
                "Obese": "red"
            }

            self.visual_label.config(text=f"Category: {category}", foreground=colors[category])

            save_bmi(user, weight, height, bmi, category)
            self.load_history()

        except ValueError:
            messagebox.showerror("Error", "Enter valid numbers")

    def load_history(self, event=None):
        user = self.user_var.get()
        if not user:
            return

        self.history_box.delete(0, tk.END)
        for w, h, bmi, cat, date in get_history(user):
            self.history_box.insert(
                tk.END,
                f"{date} | BMI {bmi} ({cat}) | W:{w}kg H:{h}cm"
            )

    def view_trends(self):
        user = self.user_var.get()
        history = get_history(user)

        if len(history) < 2:
            messagebox.showinfo("Info", "Not enough data for trends")
            return

        dates = [datetime.strptime(r[4], "%Y-%m-%d %H:%M:%S") for r in history]
        bmis = [r[2] for r in history]

        plt.figure(figsize=(8, 4))
        plt.plot(dates, bmis, marker="o")
        plt.title(f"BMI Trend - {user}")
        plt.xlabel("Date")
        plt.ylabel("BMI")
        plt.grid(True)
        plt.tight_layout()
        plt.show()


# ---------------- RUN ---------------- #
if __name__ == "__main__":
    root = tk.Tk()
    app = BMICalculator(root)
    root.mainloop()
